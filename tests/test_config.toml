# Test configuration for integration tests
# Paths and patterns are designed to match the test JSON files

[audit]
audit_file = "/tmp/claude-test-audit.json"
audit_level = "off"
passthrough_log_file = "/tmp/claude-test-passthrough.json"

[variables]
FILE_CMDS = "awk|cat|colordiff|comm|cut|diff|expand|file|fmt|fold|grep|head|join|nl|od|paste|rg|sed|seq|shuf|sort|tac|tail|tee|tr|unexpand|uniq|wc|xargs"
FS_CMDS = "basename|chmod|cp|dirname|du|df|find|ls|mkdir|mktemp|readlink|realpath|stat|touch"
SYS_CMDS = "date|done|du|echo|env|export|expr|false|for|id|nproc|numfmt|printenv|printf|pwd|sleep|sort|source|test|timeout|true|tty|uname|which|whoami"
SAFE_CMDS = "${FILE_CMDS}|${FS_CMDS}|${SYS_CMDS}"
NO_CMD_SUB = "`|\\$\\("

NSH_PATH = "^/Users/korny/Dropbox/prj/"
CLAUDE_PATH = "^/Users/korny/\\.claude/"

# Deny rules - checked first (take precedence)

# Deny path traversal in Read operations
[[deny]]
tool = "Read"
file_path_regex = ".*\\.\\./.*"

# Deny rm commands anywhere in a command string
[[deny]]
tool = "Bash"
command_regex = "\\brm\\b"

# Deny sensitive file reads
[[deny]]
tool = "Read"
file_path_regex = "\\.(env|secret)$"

# Deny git commit - use \b word boundaries so flags between git and commit
# are caught (e.g. "git --no-pager commit", "git -C /tmp commit")
[[deny]]
tool = "Bash"
command_regex = ".*\\bgit\\b.*\\bcommit\\b"

# Deny git stash - same pattern
[[deny]]
tool = "Bash"
command_regex = ".*\\bgit\\b.*\\bstash\\b"

# Deny git rm - catches "git rm file" and "git -C /path rm file"
[[deny]]
tool = "Bash"
command_regex = ".*\\bgit\\b.*\\brm\\b"

# Deny heredocs (<<EOF, <<'EOF', <<"EOF", <<-EOF, etc.)
[[deny]]
tool = "Bash"
command_regex = "<<-?\\s*['\"]?\\w+"
reason = "Do not use heredocs (<<EOF). Write code to a .py or .sh file instead."

# Deny hardcoded homebrew python -c (inline code)
[[deny]]
tool = "Bash"
command_regex = "/opt/homebrew/bin/python3[^\\s]*\\s+-c\\b"
reason = "Do not use /opt/homebrew/bin/python3 -c with inline code. Write a .py file and run it with 'source source_me.sh && python3 script.py' or 'python3 script.py'."

# Allow rules - checked after deny rules

# Allow reads within the Dropbox project directory
[[allow]]
tool = "Read"
file_path_regex = "^/Users/korny/Dropbox/prj/.*"
file_path_exclude_regex = "\\.\\."

# Allow writes within the Dropbox project directory
[[allow]]
tool = "Write"
file_path_regex = "^/Users/korny/Dropbox/prj/.*"
file_path_exclude_regex = "\\.\\."

# Allow edits within the Dropbox project directory
[[allow]]
tool = "Edit"
file_path_regex = "^/Users/korny/Dropbox/prj/.*"
file_path_exclude_regex = "\\.\\."

# Allow Glob within the Dropbox project directory
[[allow]]
tool = "Glob"
file_path_regex = "^/Users/korny/Dropbox/prj/"

# Allow Grep within the Dropbox project directory
[[allow]]
tool = "Grep"
file_path_regex = "^/Users/korny/Dropbox/prj/"

# Allow homebrew python running .py files directly (but not -c)
[[allow]]
tool = "Bash"
command_regex = "^/opt/homebrew/bin/python3[^\\s]*\\s+[^-]"
command_exclude_regex = "\\s-c\\b|${NO_CMD_SUB}"

# Write/Edit access to Claude internal files (~/.claude/)
[[allow]]
tool = "Write"
file_path_regex = "${CLAUDE_PATH}"
file_path_exclude_regex = "\\.\\."

[[allow]]
tool = "Edit"
file_path_regex = "${CLAUDE_PATH}"
file_path_exclude_regex = "\\.\\."

# Allow safe cargo commands
[[allow]]
tool = "Bash"
command_regex = "^cargo (build|test|check|clippy|fmt|run)"
command_exclude_regex = "${NO_CMD_SUB}"

# Allow common shell utilities (narrow exclude: blocks command substitution only)
[[allow]]
tool = "Bash"
command_regex = "^(${SAFE_CMDS})\\b"
command_exclude_regex = "${NO_CMD_SUB}"

# Allow specific subagent types
[[allow]]
tool = "Task"
subagent_type = "codebase-analyzer"

# Tool-only rules (match any input for the tool)
[[allow]]
tool = "WebFetch"

[[allow]]
tool = "WebSearch"
